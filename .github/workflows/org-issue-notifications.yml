name: Organization-Wide Issue Notifications

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'org-wide')

    steps:
      - name: Check if this is an org-wide issue
        id: check_labels
        run: |
          echo "Issue has org-wide label"

      - name: Extract issue details
        id: issue_details
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          # Use environment variable to avoid code injection
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT

      - name: Determine severity and urgency
        id: categorize
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          echo "labels=$LABELS"

          if echo "$LABELS" | grep -q "urgent\|critical"; then
            echo "priority=urgent" >> $GITHUB_OUTPUT
            echo "emoji=🚨" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "high-priority\|security"; then
            echo "priority=high" >> $GITHUB_OUTPUT
            echo "emoji=⚠️" >> $GITHUB_OUTPUT
          else
            echo "priority=normal" >> $GITHUB_OUTPUT
            echo "emoji=📢" >> $GITHUB_OUTPUT
          fi

      - name: Post comment with notification info
        uses: actions/github-script@v7
        with:
          script: |
            const priority = '${{ steps.categorize.outputs.priority }}';
            const emoji = '${{ steps.categorize.outputs.emoji }}';

            let message = `${emoji} **Organization-Wide Issue Alert**\n\n`;
            message += `This issue has been tagged as organization-wide and will be tracked centrally.\n\n`;
            message += `**Priority:** ${priority}\n`;
            message += `**Labels:** ${{ join(github.event.issue.labels.*.name, ', ') }}\n\n`;

            if (priority === 'urgent') {
              message += `⚠️ This is marked as **URGENT** and requires immediate attention from relevant teams.\n\n`;
            }

            message += `### Next Steps:\n`;
            message += `- [ ] Review and triage this issue\n`;
            message += `- [ ] Identify affected teams and repositories\n`;
            message += `- [ ] Create linked issues in affected repositories if needed\n`;
            message += `- [ ] Add to relevant project boards\n\n`;
            message += `---\n`;
            message += `*This notification was automatically generated. Teams can subscribe to notifications by watching this repository.*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Add to project (if configured)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            // This is a placeholder for adding issues to GitHub Projects
            // Configure PROJECT_ID in repository secrets to enable this
            console.log('Project integration can be configured with organization projects');

      - name: Create notification summary
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ steps.issue_details.outputs.issue_author }}
          ISSUE_NUMBER: ${{ steps.issue_details.outputs.issue_number }}
          ISSUE_URL: ${{ steps.issue_details.outputs.issue_url }}
          PRIORITY: ${{ steps.categorize.outputs.priority }}
          LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
        run: |
          echo "## 📢 Organization-Wide Issue Notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** #${ISSUE_NUMBER} - ${ISSUE_TITLE}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${ISSUE_AUTHOR}" >> $GITHUB_STEP_SUMMARY
          echo "**Priority:** ${PRIORITY}" >> $GITHUB_STEP_SUMMARY
          echo "**Labels:** ${LABELS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [View Issue](${ISSUE_URL})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notification Methods" >> $GITHUB_STEP_SUMMARY
          echo "- Comment added to issue" >> $GITHUB_STEP_SUMMARY
          echo "- Notification sent to repository watchers" >> $GITHUB_STEP_SUMMARY
          echo "- Summary generated for workflow visibility" >> $GITHUB_STEP_SUMMARY
